--뷰 정의하기(뷰를 생성할 권한을 줘야함)
--CONN system/manager //DBA 권한이 있는 사용자만이 부여할 수 있으므로 SYSTEM 계정으로 접속
--GRANT CREATE VIEW TO scott; //뷰를 생성할 권한부여
CREATE VIEW EMP_VIEW30
AS
SELECT EMPNO, ENAME, DEPTNO
FROM EMP_COPY
WHERE DEPTNO=30;

SELECT * FROM EMP_VIEW30; 
--같은 뷰이름으로 조건을 다르게 하고싶을 때
CREATE OR REPLACE VIEW EMP_VIEW30
AS
SELECT EMPNO, ENAME, DEPTNO
FROM EMP_COPY
WHERE DEPTNO=20;
--1. 기본 테이블은 EMP_COPY로 하여 20번 부서에 소속된 사원들의 사번과 이름과 부서번호와 상관의 사번을 출력하기 위한 SELECT문을 EMP_VIEW20
--이란 이름의 뷰로 정의해 봅시다.
CREATE OR REPLACE VIEW EMP_VIEW20
AS
SELECT EMPNO, ENAME, DEPTNO,MGR
FROM EMP_COPY
WHERE DEPTNO=20;

SELECT * FROM EMP_VIEW20;
--USER_VIEWS에서 테이블 이름과 텍스트만 출력
SELECT VIEW_NAME, TEXT
FROM USER_VIEWS;
--뷰에 행을 하나 추가
INSERT INTO EMP_VIEW30 VALUES(1111, 'AAAA', 30);
SELECT * FROM EMP_VIEW30;
SELECT * FROM EMP_COPY; 

INSERT INTO EMP_VIEW30
VALUES(8000, 'ANGEL', 30);
SELECT * FROM EMP_VIEW30;
commit;

delete from emp_view30 where empno =8000;
rollback;
------------------실습예제-----------------
CREATE OR REPLACE
VIEW EMP_VIEW(사원번호, 사원명, 급여, 부서번호)
AS
SELECT EMPNO, ENAME, SAL, DEPTNO
FROM EMP_COPY;

SELECT * FROM EMP_VIEW
WHERE 부서번호=30;
--단순 뷰 만들기
CREATE VIEW VIEW_SAL
AS
SELECT DEPTNO, SUM(SAL) AS "SalSum",
AVG(SAL) AS "SalAvg"
FROM EMP_COPY
GROUP BY DEPTNO; 
--------------------------------------
--복합 뷰 만들기
CREATE OR REPLACE VIEW EMP_VIEW_DEPT
AS
SELECT E.EMPNO, E.ENAME, E.SAL, E.DEPTNO, D.DNAME, D.LOC
FROM EMP E, DEPT D
WHERE E.DEPTNO = D.DEPTNO
ORDER BY EMPNO DESC; 
SELECT * FROM EMP_VIEW_DEPT; 
--예제
CREATE VIEW SAL_VIEW
AS
SELECT D.DNAME,MAX(E.SAL)"MAX_SAL",MIN(E.SAL)"MIN_SAL"
FROM EMP E,DEPT D
WHERE E.DEPTNO=D.DEPTNO
GROUP BY D.DNAME;
SELECT * FROM SAL_VIEW;
--뷰 삭제(뷰를 삭제해도 뷰를 정의한 기본 테이블의 구조나 데이터에는 영향없음)
DROP VIEW VIEW_SAL;
--예제
CREATE OR REPLACE VIEW EMP_VIEW30
AS
SELECT EMPNO, ENAME, SAL, COMM, DEPTNO
FROM EMP_COPY
WHERE DEPTNO=30; 

CREATE OR REPLACE VIEW EMP_VIEW20
AS
SELECT EMPNO"EMP_NO", ENAME"EMP_NAME", DEPTNO"DEPT_NO",MGR"MANAGER"
FROM EMP_COPY
WHERE DEPTNO=20; 
SELECT * FROM EMP_VIEW20;
--조건 컬럼 값 변경 못하게 하는 WITH CHECK OPTION
CREATE OR REPLACE VIEW VIEW_CHK30
AS
SELECT EMPNO, ENAME, SAL, COMM, DEPTNO
FROM EMP_COPY
WHERE DEPTNO=30 WITH CHECK OPTION;
--뷰의 WITH CHECK OPTION의 조건에 위배 됩니다
UPDATE VIEW_CHK30 SET DEPTNO=20
WHERE SAL>=1200;
SELECT * FROM VIEW_CHK30;
--WITH READ ONLY은 뷰를 설정할 때 조건으로 설정한 컬럼이 아닌 컬럼에
--대해서도 변경 불가능하므로 켜미션이 컬럼 값 역시 변경에 실패합니다.
--뷰를 통해서 기본 테이블을 절대 변경할 수 없게 됩니다.
CREATE OR REPLACE VIEW VIEW_READ30
AS
SELECT EMPNO, ENAME, SAL, COMM, DEPTNO
FROM EMP_COPY
WHERE DEPTNO=30 WITH READ ONLY; 
UPDATE VIEW_READ30 SET COMM=2000; 

CREATE OR REPLACE VIEW VIEW_HIRE
AS
SELECT EMPNO, ENAME, HIREDATE
FROM EMP
ORDER BY HIREDATE;
SELECT * FROM VIEW_HIRE;
--ROWNUM 원리알기
SELECT ROWNUM, EMPNO, ENAME, HIREDATE
FROM VIEW_HIRE;

 
--인라인 뷰로 TOP-N 구하기
SELECT ROWNUM, EMPNO, ENAME, HIREDATE
FROM ( SELECT EMPNO, ENAME, HIREDATE
FROM EMP
ORDER BY HIREDATE)
WHERE ROWNUM<=5; 
--인라인 뷰로 사이값 구하기(한번 더 이해)
SELECT RNUM, EMPNO, ENAME, HIREDATE
FROM ( SELECT ROWNUM RNUM, EMPNO, ENAME, HIREDATE
    FROM (SELECT EMPNO, ENAME, HIREDATE
    FROM EMP
    ORDER BY HIREDATE))
WHERE RNUM>=5 AND RNUM<=10; 



